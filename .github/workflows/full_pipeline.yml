name: Full Crime Pipeline (SF+FR)

on:
  schedule:
    - cron: "0 14,15 * * *"   # SF 07:00: 14:00 UTC (yaz), 15:00 UTC (kƒ±≈ü)
  workflow_dispatch:
    inputs:
      persist:
        description: "Sonu√ßlarƒ± nasƒ±l saklayalƒ±m?"
        type: choice
        options: [artifact, release, commit, none]
        default: artifact
      force:
        description: "Manuel tetiklemede 07:00 kapƒ±sƒ±nƒ± YOK SAY"
        type: boolean
        default: true
      top_k:
        description: "Stacking: her saat dilimi i√ßin √∂nerilecek GEOID sayƒ±sƒ±"
        default: "50"
      variant:
        description: "Pipeline varyantƒ± (default | fr)"
        type: choice
        options: [default, fr]
        default: fr

permissions:
  actions: read
  contents: write

concurrency:
  group: full-pipeline-${{ github.ref }}
  cancel-in-progress: true

env:
  CRIME_DATA_DIR: crime_prediction_data
  GEOID_LEN: "11"

  BACKFILL_DAYS: "0"
  SF_SODA_FETCH_STRATEGY: ${{ vars.SF_SODA_FETCH_STRATEGY || 'bulk' }}
  SF_SODA_PAGE_LIMIT:    ${{ vars.SF_SODA_PAGE_LIMIT    || '50000' }}
  SF_SODA_MAX_PAGES:     ${{ vars.SF_SODA_MAX_PAGES     || '100' }}

  SF911_API_URL:       ${{ vars.SF911_API_URL       || 'https://data.sfgov.org/resource/2zdj-bwza.json' }}
  SF911_AGENCY_FILTER: ${{ vars.SF911_AGENCY_FILTER || 'agency like "%Police%"' }}
  SF911_API_TOKEN:     ${{ secrets.SF911_API_TOKEN }}
  SOCS_APP_TOKEN:      ${{ secrets.SOCS_APP_TOKEN }}

  PATROL_TOP_K: ${{ github.event.inputs.top_k || '50' }}

  PATROL_HORIZON_DAYS: "3"
  WX_LOCATION: "san francisco"
  WX_UNIT: "us"

  ACS_YEAR: ${{ vars.ACS_YEAR || 'LATEST' }}
  DEMOG_WHITELIST: ${{ vars.DEMOG_WHITELIST || '' }}
  CENSUS_GEO_LEVEL: ${{ vars.CENSUS_GEO_LEVEL || 'auto' }}
  PIPELINE_VARIANT: ${{ github.event.inputs.variant || vars.PIPELINE_VARIANT || 'fr' }}

  # FR √ßƒ±ktƒ±larƒ±nƒ± saklama modu (schedule tetiklerinde de √ßalƒ±≈üsƒ±n)
  PERSIST_MODE: ${{ github.event.inputs.persist || 'artifact' }}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS objects
        run: |
          git lfs install
          git lfs pull
          echo "Repo root:"; ls -lah
          echo "crime_prediction_data:"; ls -lah crime_prediction_data || true
          echo "CRIME_DATA_DIR:"; ls -lah "${CRIME_DATA_DIR}" || true

      - name: Ensure data dir
        run: mkdir -p "${CRIME_DATA_DIR}"

      # --- SF 07:00 kapƒ±sƒ± (TZ ayarla + saat kontrol√º) ---
      - name: Set runner timezone to America/Los_Angeles
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "America/Los_Angeles"

      - name: Gate by local SF time == 07 (bypassable)
        id: gate
        run: |
          now="$(date)"
          echo "Runner local time: $now"
          echo "RUN_LOCAL_TIME=$now" >> $GITHUB_ENV
          # Manuel + force=true ise doƒürudan ge√ß
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Aksi halde 07:00 kontrol√º
          if [ "$(date +%H)" = "07" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: Debug variant
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          echo "PIPELINE_VARIANT=${PIPELINE_VARIANT}"

      - name: Skip summary (outside 07:00 and not forced)
        if: ${{ steps.gate.outputs.proceed != 'true' }}
        run: |
          {
            echo "## SF Crime Pipeline"
            echo ""
            echo "- √áalƒ±≈üma zamanƒ± (SF): **$(date)**"
            echo "- Not: 07:00 kapƒ±sƒ± nedeniyle adƒ±mlar atlandƒ±. Manuel tetiklerken \`force=true\` verin."
          } >> $GITHUB_STEP_SUMMARY

      - name: System deps for rtree (optional)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: sudo apt-get update && sudo apt-get install -y libspatialindex-dev

      - name: Set up Python 3.11
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          python -m pip install -U pip wheel setuptools
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install -U "geopandas==1.0.1" "shapely==2.0.4" "pyproj==3.6.1" "pyogrio==0.9.0" "rtree==1.3.0"

      - name: Geo stack smoke test
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          python - <<'PY'
          import geopandas, shapely, pyproj, pyogrio, pandas
          print("geopandas", geopandas.__version__)
          print("shapely", shapely.__version__)
          print("pyproj", pyproj.__version__)
          print("pyogrio", pyogrio.__version__)
          print("pandas", pandas.__version__)
          PY

      # >>> Prefetch sf_crime_y.csv
      - name: "00) Prefetch sf_crime_y.csv from previous successful run (artifact)"
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_NAME: sf-crime-pipeline-output
          WORKFLOW_NAME: Full Crime Pipeline (SF+FR)
          TARGET_FILE: sf_crime_y.csv
          OUT_DIR: crime_prediction_data
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"
          if [ -f "${OUT_DIR}/${TARGET_FILE}" ]; then
            echo "‚ÑπÔ∏è ${OUT_DIR}/${TARGET_FILE} zaten var, indirme atlandƒ±."
            exit 0
          fi
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y unzip >/dev/null
          if ! command -v gh >/dev/null; then
            type -p curl >/dev/null && sudo curl -sSL https://raw.githubusercontent.com/cli/cli/trunk/script/install.sh | sh
          fi
          mkdir -p _prev
          FOUND=""
          RUNS=$(gh run list -R "${GITHUB_REPOSITORY}" --workflow "${WORKFLOW_NAME}" --status success -L 10 --json databaseId -q '.[].databaseId' || true)
          for RID in ${RUNS}; do
            rm -rf "_prev/$RID" && mkdir -p "_prev/$RID"
            if gh run download -R "${GITHUB_REPOSITORY}" "$RID" -n "${ARTIFACT_NAME}" -D "_prev/$RID" >/dev/null 2>&1; then
              F=$(find "_prev/$RID" -type f -iname "${TARGET_FILE}" | head -n1 || true)
              if [ -n "${F:-}" ]; then
                cp -f "$F" "${OUT_DIR}/${TARGET_FILE}"
                echo "‚úÖ Bulundu ve kopyalandƒ±: $F ‚Üí ${OUT_DIR}/${TARGET_FILE}"
                FOUND="yes"; break
              fi
            fi
          done
          if [ -z "${FOUND}" ]; then
            echo "‚ÑπÔ∏è ${TARGET_FILE} ge√ßmi≈ü artifact‚Äôlarda bulunamadƒ±; release fallback devreye girebilir."
          fi
      # <<<

      # ---- PIPELINE ----
      
      # =========================
      # 01) Crime (SF √∂nce, FR sonra, head 5)
      # =========================
      - name: 01) Su√ß tabanƒ± ve grid ‚Üí sf_crime.csv + gridler
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          Y_CSV_NAME: ${{ env.CRIME_DATA_DIR }}/sf_crime_y.csv
          CACHE_WRITE_Y_ONLY: "1"
        run: |
          set -e
          PY="update_crime.py"
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_crime.fr.py" ]; then PY="update_crime.fr.py";
            elif [ -f "update_crime_fr.py" ]; then PY="update_crime_fr.py"; fi
          fi
          python -u "$PY"
          [ -f "${CRIME_DATA_DIR}/sf_crime.csv" ] && { echo "---- sf_crime.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime.csv" || true; }
      
      - name: 01.1) GEOID+Y_label ‚Üí sf_crime_L.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
          GEOID_LEN: ${{ env.GEOID_LEN }}
          AGGR_Y_THRESHOLD: ${{ env.AGGR_Y_THRESHOLD || '1' }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, pandas as pd
          cdir = os.environ["CRIME_DATA_DIR"]
          L   = int(os.environ.get("GEOID_LEN","11"))
          TH  = int(os.environ.get("AGGR_Y_THRESHOLD","1"))
          def norm_geoid(s):
              return s.astype(str).str.extract(r"(\d+)", expand=False).str[:L].str.zfill(L)
          grid_candidates = ["sf_crime_grid_full_labeled.csv", os.path.join(cdir, "sf_crime_grid_full_labeled.csv")]
          grid_src = next((p for p in grid_candidates if os.path.isfile(p)), None)
          if grid_src:
              df = pd.read_csv(grid_src, low_memory=False); cols = {c.lower(): c for c in df.columns}
              if "y_label" not in cols:
                  if "crime_count" in cols:
                      df["Y_label"] = (pd.to_numeric(df[cols["crime_count"]], errors="coerce").fillna(0) >= TH).astype(int)
                  else:
                      raise SystemExit(f"GRID var ama Y_label/crime_count yok. Kolonlar: {list(df.columns)}")
              geoid_col = cols.get("geoid");  assert geoid_col, "GRID'de GEOID yok"
              out = df[[geoid_col, "Y_label"]].copy(); out.columns = ["GEOID","Y_label"]; out["GEOID"] = norm_geoid(out["GEOID"])
              out = out.groupby("GEOID", as_index=False)["Y_label"].max()
          else:
              import itertools
              src=None
              for name in ("sf_crime_y.csv","sf_crime.csv"):
                  p=os.path.join(cdir,name)
                  if os.path.isfile(p): src=p; break
              assert src, "Girdi yok: GRID ya da sf_crime_y.csv/sf_crime.csv bulunamadƒ±."
              df = pd.read_csv(src, low_memory=False); low={c.lower():c for c in df.columns}
              geoid_col = low.get("geoid") or low.get("geography_id") or low.get("geoid11") or low.get("geoid_11"); assert geoid_col, "GEOID kolonu yok"
              g = df[[geoid_col]].copy(); g.columns=["GEOID"]; g["GEOID"]=norm_geoid(g["GEOID"])
              g=g.dropna(); g=g[g["GEOID"]!=""]; g=g.drop_duplicates(); g["Y_label"]=1; out=g
          dest = os.path.join(cdir,"sf_crime_L.csv"); out.to_csv(dest,index=False); print(f"Yazƒ±ldƒ±: {dest} | satƒ±r: {len(out)}")
          PY
          echo "---- sf_crime_L.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_L.csv" || true
      
      - name: 01.2) fr_crime.csv olu≈ütur
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          FR_SRC_PATH: ${{ env.CRIME_DATA_DIR }}/sf_crime_grid_full_labeled.csv
          FR_OUT_PATH: fr_crime.csv
          FR_MIRROR_DIR: crime_prediction_data_pre
        run: |
          set -e
          echo "‚û°Ô∏è fr_crime.csv √ºretiliyor..."
          if [ -f "update_crime_fr.py" ]; then
            python -u update_crime_fr.py
          else
            python - <<'PY'
            import pandas as pd, os, shutil
            from pathlib import Path
            src = Path(os.getenv("FR_SRC_PATH","sf_full_labeled.csv"))
            if not src.exists(): raise SystemExit(f"‚ùå Kaynak bulunamadƒ±: {src}")
            out = Path(os.getenv("FR_OUT_PATH","fr_crime.csv"))
            mir = Path(os.getenv("FR_MIRROR_DIR","crime_prediction_data_pre"))
            df = pd.read_csv(src, low_memory=False); df["GEOID"]=df["GEOID"].astype(str).str.zfill(11)
            df.to_csv(out, index=False); mir.mkdir(exist_ok=True); shutil.copy2(out, mir/out.name)
            print(f"‚úÖ Kaydedildi: {out} ({len(df):,} satƒ±r)")
            PY
          fi
          head -n 5 fr_crime.csv || true
      
      # =========================
      # 02) 911 ‚Ä¢ SF & FR (head 5 + fallback)
      # =========================
      - name: Restore 911 summary cache
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        uses: actions/cache@v4
        with:
          path: ${{ env.CRIME_DATA_DIR }}/sf_911_last_5_year.csv
          key: 911-${{ runner.os }}-${{ github.run_number }}
          restore-keys: |
            911-${{ runner.os }}-
      
      - name: Prefetch sf_911_last_5_year_y.csv from previous successful run (artifact)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_NAME: sf-crime-pipeline-output
          WORKFLOW_NAME: Full Crime Pipeline (SF+FR)
          TARGET_FILE: sf_911_last_5_year_y.csv
          OUT_DIR: crime_prediction_data
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"
          if [ -f "${OUT_DIR}/${TARGET_FILE}" ]; then
            echo "‚ÑπÔ∏è ${OUT_DIR}/${TARGET_FILE} zaten var, indirme atlandƒ±."
            exit 0
          fi
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y unzip >/dev/null
          if ! command -v gh >/dev/null; then
            type -p curl >/dev/null && sudo curl -sSL https://raw.githubusercontent.com/cli/cli/trunk/script/install.sh | sh
          fi
          mkdir -p _prev
          FOUND=""
          for RID in $(gh run list -R "${GITHUB_REPOSITORY}" --workflow "${WORKFLOW_NAME}" --status success -L 10 --json databaseId -q '.[].databaseId'); do
            rm -rf "_prev/$RID" && mkdir -p "_prev/$RID"
            if gh run download -R "${GITHUB_REPOSITORY}" "$RID" -n "${ARTIFACT_NAME}" -D "_prev/$RID" >/dev/null 2>&1; then
              F=$(find "_prev/$RID" -type f -iname "${TARGET_FILE}" | head -n1 || true)
              if [ -n "${F:-}" ]; then
                cp -f "$F" "${OUT_DIR}/${TARGET_FILE}"
                echo "‚úÖ Bulundu ve kopyalandƒ±: $F ‚Üí ${OUT_DIR}/${TARGET_FILE}"
                FOUND="yes"; break
              fi
            fi
          done
          if [ -z "${FOUND}" ]; then
            echo "‚ÑπÔ∏è ${TARGET_FILE} √∂nceki artifact‚Äôlarda bulunamadƒ±; script release fallback kullanacak."
          fi
      
      - name: 02) 911 ‚Üí sf_crime_01.csv (bulk 50k)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          SF_SODA_FETCH_STRATEGY: ${{ env.SF_SODA_FETCH_STRATEGY }}
          SF_SODA_PAGE_LIMIT:    ${{ env.SF_SODA_PAGE_LIMIT }}
          SF_SODA_MAX_PAGES:     ${{ env.SF_SODA_MAX_PAGES }}
          SF911_API_URL:         ${{ env.SF911_API_URL }}
          SF911_AGENCY_FILTER:   ${{ env.SF911_AGENCY_FILTER }}
          SF911_API_TOKEN:       ${{ env.SF911_API_TOKEN }}
          SOCS_APP_TOKEN:        ${{ env.SOCS_APP_TOKEN }}
          BACKFILL_DAYS:         ${{ env.BACKFILL_DAYS }}
        run: |
          set -e
          PY="update_911.py"
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_911.fr.py" ]; then PY="update_911.fr.py";
            elif [ -f "update_911_fr.py" ]; then PY="update_911_fr.py"; fi
          fi
          python -u "$PY"
          [ -f "${CRIME_DATA_DIR}/sf_crime_01.csv" ] && { echo "---- sf_crime_01.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_01.csv" || true; }
      
      - name: FR 01) 911 ‚Üí fr_crime_01.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && (env.PIPELINE_VARIANT == 'fr' || hashFiles('**/update_911.fr.py', '**/update_911_fr.py', 'scripts/update_911.fr.py', 'scripts/update_911_fr.py') != '') }}
        env:
          SF_SODA_FETCH_STRATEGY: ${{ env.SF_SODA_FETCH_STRATEGY }}
          SF_SODA_PAGE_LIMIT:    ${{ env.SF_SODA_PAGE_LIMIT }}
          SF_SODA_MAX_PAGES:     ${{ env.SF_SODA_MAX_PAGES }}
          SF911_API_URL:         ${{ env.SF911_API_URL }}
          SF911_AGENCY_FILTER:   ${{ env.SF911_AGENCY_FILTER }}
          SF911_API_TOKEN:       ${{ env.SF911_API_TOKEN }}
          SOCS_APP_TOKEN:        ${{ env.SOCS_APP_TOKEN }}
          BACKFILL_DAYS:         ${{ env.BACKFILL_DAYS }}
          CRIME_DATA_DIR:        ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if   [ -f "update_911.fr.py" ]; then PY="update_911.fr.py";
          elif [ -f "update_911_fr.py" ]; then PY="update_911_fr.py";
          elif [ -f "scripts/update_911.fr.py" ]; then PY="scripts/update_911.fr.py";
          elif [ -f "scripts/update_911_fr.py" ]; then PY="scripts/update_911_fr.py";
          else echo "‚Ü™Ô∏è FR 911 scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_01.csv" || { echo "‚ùå fr_crime_01.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_01.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_01.csv" || true
      
      # =========================
      # 03) 311 ‚Ä¢ SF & FR (head 5 + fallback)
      # =========================
      - name: Restore 311 summary cache
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        uses: actions/cache@v4
        with:
          path: ${{ env.CRIME_DATA_DIR }}/sf_311_last_5_years.csv
          key: 311-${{ runner.os }}-${{ github.run_number }}
          restore-keys: |
            311-${{ runner.os }}-
      
      - name: Prefetch sf_311_last_5_years_y.csv from previous successful run (artifact)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_NAME: sf-crime-pipeline-output
          WORKFLOW_NAME: Full Crime Pipeline (SF+FR)
          TARGET_FILE: sf_311_last_5_years_y.csv
          OUT_DIR: crime_prediction_data
        run: |
          set -euo pipefail
          mkdir -p "${OUT_DIR}"
          if [ -f "${OUT_DIR}/${TARGET_FILE}" ]; then
            echo "‚ÑπÔ∏è ${OUT_DIR}/${TARGET_FILE} zaten var, indirme atlandƒ±."
            exit 0
          fi
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y unzip >/dev/null
          if ! command -v gh >/dev/null; then
            type -p curl >/dev/null && sudo curl -sSL https://raw.githubusercontent.com/cli/cli/trunk/script/install.sh | sh
          fi
          mkdir -p _prev
          FOUND=""
          for RID in $(gh run list -R "${GITHUB_REPOSITORY}" --workflow "${WORKFLOW_NAME}" --status success -L 10 --json databaseId -q '.[].databaseId'); do
            rm -rf "_prev/$RID" && mkdir -p "_prev/$RID"
            if gh run download -R "${GITHUB_REPOSITORY}" "$RID" -n "${ARTIFACT_NAME}" -D "_prev/$RID" >/dev/null 2>&1; then
              F=$(find "_prev/$RID" -type f -iname "${TARGET_FILE}" | head -n1 || true)
              if [ -n "${F:-}" ]; then
                cp -f "$F" "${OUT_DIR}/${TARGET_FILE}"
                echo "‚úÖ Bulundu ve kopyalandƒ±: $F ‚Üí ${OUT_DIR}/${TARGET_FILE}"
                FOUND="yes"; break
              fi
            fi
          done
          if [ -z "${FOUND}" ]; then
            echo "‚ÑπÔ∏è ${TARGET_FILE} √∂nceki artifact‚Äôlarda bulunamadƒ±; update_311.py kendi akƒ±≈üƒ±yla devam edecek."
          fi
      
      - name: 03) 311 ‚Üí sf_crime_02.csv (bulk 50k)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          SF_SODA_FETCH_STRATEGY: ${{ env.SF_SODA_FETCH_STRATEGY }}
          SF_SODA_PAGE_LIMIT:    ${{ env.SF_SODA_PAGE_LIMIT }}
          SF_SODA_MAX_PAGES:     ${{ env.SF_SODA_MAX_PAGES }}
          SOCS_APP_TOKEN:        ${{ env.SOCS_APP_TOKEN }}
          BACKFILL_DAYS:         ${{ env.BACKFILL_DAYS }}
        run: |
          set -e
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_311.fr.py" ]; then PY="update_311.fr.py";
            elif [ -f "update_311_fr.py" ]; then PY="update_311_fr.py";
            elif [ -f "scripts/update_311.fr.py" ]; then PY="scripts/update_311.fr.py";
            elif [ -f "scripts/update_311_fr.py" ]; then PY="scripts/update_311_fr.py";
            elif [ -f "update_311.py" ]; then PY="update_311.py";
            else PY="scripts/update_311.py"; fi
          else
            if [ -f "update_311.py" ]; then PY="update_311.py"; else PY="scripts/update_311.py"; fi
          fi
          python -u "$PY"
          [ -f "${CRIME_DATA_DIR}/sf_crime_02.csv" ] && { echo "---- sf_crime_02.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_02.csv" || true; }
      
      - name: FR 02) 311 ‚Üí fr_crime_02.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          SF_SODA_FETCH_STRATEGY: ${{ env.SF_SODA_FETCH_STRATEGY }}
          SF_SODA_PAGE_LIMIT:    ${{ env.SF_SODA_PAGE_LIMIT }}
          SF_SODA_MAX_PAGES:     ${{ env.SF_SODA_MAX_PAGES }}
          SOCS_APP_TOKEN:        ${{ env.SOCS_APP_TOKEN }}
          BACKFILL_DAYS:         ${{ env.BACKFILL_DAYS }}
          CRIME_DATA_DIR:        ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if   [ -f "update_311.fr.py" ]; then PY="update_311.fr.py";
          elif [ -f "update_311_fr.py" ]; then PY="update_311_fr.py";
          elif [ -f "scripts/update_311.fr.py" ]; then PY="scripts/update_311.fr.py";
          elif [ -f "scripts/update_311_fr.py" ]; then PY="scripts/update_311_fr.py";
          else echo "‚Ü™Ô∏è FR 311 scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_02.csv" || { echo "‚ùå fr_crime_02.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_02.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_02.csv" || true
      
      # =========================
      # 04) Population/Demografi ‚Ä¢ SF & FR (head 5)
      # =========================
      - name: Ensure population CSV (local file)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -euo pipefail
          mkdir -p "${CRIME_DATA_DIR}"
          DEST="${CRIME_DATA_DIR}/sf_population.csv"
          CANDIDATES=("${CRIME_DATA_DIR}/sf_population.csv" "sf_population.csv" "data/sf_population.csv" "inputs/sf_population.csv")
          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then
              if [ -e "$DEST" ] && [ "$p" -ef "$DEST" ]; then
                echo "‚ÑπÔ∏è Zaten hedefte: $DEST"
              else
                cp -f "$p" "$DEST"
                echo "‚úÖ Copied: $p ‚Üí $DEST"
              fi
              FOUND="yes"; break
            fi
          done
          if [ -z "$FOUND" ]; then
            echo "‚ùå sf_population.csv bulunamadƒ±. L√ºtfen repo‚Äôya ekleyin veya ${CRIME_DATA_DIR} altƒ±na yerle≈ütirin."
            exit 2
          fi
          echo "---- sf_population.csv (head) ----"; head -n 5 "$DEST" || true
      
      - name: (Opsiyonel) sf_population.csv ba≈ülƒ±k normalize
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          python - <<'PY'
          import os, pandas as pd
          p = os.path.join(os.environ["CRIME_DATA_DIR"], "sf_population.csv")
          df = pd.read_csv(p)
          low = {c.lower(): c for c in df.columns}
          if 'geoid' not in low and 'geography_id' in low:
              df.rename(columns={low['geography_id']: 'GEOID'}, inplace=True)
          for cand in ['population','total_population','b01003_001e','estimate','total','value']:
              if cand in low:
                  if 'population' not in df.columns:
                      df.rename(columns={low[cand]: 'population'}, inplace=True)
                  break
          df.to_csv(p, index=False)
          print("Normalized headers:", df.columns.tolist())
          PY
      
      - name: 04) N√ºfus ‚Üí sf_crime_03.csv (demografi + n√ºfus)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          POPULATION_PATH:  ${{ env.CRIME_DATA_DIR }}/sf_population.csv
          CENSUS_GEO_LEVEL: ${{ env.CENSUS_GEO_LEVEL }}
          ACS_YEAR:         ${{ env.ACS_YEAR }}
          DEMOG_WHITELIST:  ${{ env.DEMOG_WHITELIST }}
        run: |
          set -e
          PY="update_population.py"
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_population.fr.py" ]; then PY="update_population.fr.py";
            elif [ -f "update_population_fr.py" ]; then PY="update_population_fr.py"; fi
          fi
          python -u "$PY"
          [ -f "${CRIME_DATA_DIR}/sf_crime_03.csv" ] && { echo "---- sf_crime_03.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_03.csv" || true; }
      
      - name: FR 03) N√ºfus/Demografi ‚Üí fr_crime_03.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          CRIME_DATA_DIR:  ${{ env.CRIME_DATA_DIR }}
          CENSUS_GEO_LEVEL: ${{ env.CENSUS_GEO_LEVEL }}
          ACS_YEAR:         ${{ env.ACS_YEAR }}
          DEMOG_WHITELIST:  ${{ env.DEMOG_WHITELIST }}
        run: |
          set -euo pipefail
          if   [ -f "update_population.fr.py" ]; then PY="update_population.fr.py";
          elif [ -f "update_population_fr.py" ]; then PY="update_population_fr.py";
          elif [ -f "scripts/update_population.fr.py" ]; then PY="scripts/update_population.fr.py";
          elif [ -f "scripts/update_population_fr.py" ]; then PY="scripts/update_population_fr.py";
          else echo "‚Ü™Ô∏è FR n√ºfus scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_03.csv" || { echo "‚ùå fr_crime_03.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_03.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_03.csv" || true
      
      # =========================
      # 05) Bus ‚Ä¢ SF ‚Üí FR (head 5)
      # =========================
      - name: 05) Otob√ºs ‚Üí sf_crime_04.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -e
          PY="update_bus.py"
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_bus.fr.py" ]; then PY="update_bus.fr.py";
            elif [ -f "update_bus_fr.py" ]; then PY="update_bus_fr.py"; fi
          fi
          python -u "$PY"
          [ -f "${CRIME_DATA_DIR}/sf_crime_04.csv" ] && { echo "---- sf_crime_04.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_04.csv" || true; }
      
      - name: FR 04) Otob√ºs ‚Üí fr_crime_04.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          CRIME_DATA_DIR:  ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if   [ -f "update_bus.fr.py" ]; then PY="update_bus.fr.py";
          elif [ -f "update_bus_fr.py" ]; then PY="update_bus_fr.py";
          elif [ -f "scripts/update_bus.fr.py" ]; then PY="scripts/update_bus.fr.py";
          elif [ -f "scripts/update_bus_fr.py" ]; then PY="scripts/update_bus_fr.py";
          else echo "‚Ü™Ô∏è FR bus scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_04.csv" || { echo "‚ùå fr_crime_04.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_04.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_04.csv" || true
      
      # =========================
      # 06) Train ‚Ä¢ SF ‚Üí FR (head 5)
      # =========================
      - name: 06) Tren (BART) ‚Üí sf_crime_05.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -e
          PY="update_train.py"
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_train.fr.py" ]; then PY="update_train.fr.py";
            elif [ -f "update_train_fr.py" ]; then PY="update_train_fr.py"; fi
          fi
          python -u "$PY"
          [ -f "${CRIME_DATA_DIR}/sf_crime_05.csv" ] && { echo "---- sf_crime_05.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_05.csv" || true; }
      
      - name: FR 05) Tren ‚Üí fr_crime_05.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          CRIME_DATA_DIR:  ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if   [ -f "update_train.fr.py" ]; then PY="update_train.fr.py";
          elif [ -f "update_train_fr.py" ]; then PY="update_train_fr.py";
          elif [ -f "scripts/update_train.fr.py" ]; then PY="scripts/update_train.fr.py";
          elif [ -f "scripts/update_train_fr.py" ]; then PY="scripts/update_train_fr.py";
          else echo "‚Ü™Ô∏è FR train scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_05.csv" || { echo "‚ùå fr_crime_05.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_05.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_05.csv" || true
      
      # =========================
      # 07) POI ‚Ä¢ SF & FR (head 5)
      # =========================
      - name: 07) POI zenginle≈ütirme ‚Üí sf_crime_06.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -e
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_poi.fr.py" ]; then python -u update_poi.fr.py;
            elif [ -f "update_poi_fr.py" ]; then python -u update_poi_fr.py;
            elif [ -f "update_poi.py" ];    then python -u update_poi.py;
            elif [ -f "pipeline_make_sf_crime_06.py" ]; then python -u pipeline_make_sf_crime_06.py;
            else echo "POI adƒ±mƒ± bulunamadƒ±"; exit 2; fi
          else
            if [ -f update_poi.py ]; then python -u update_poi.py;
            elif [ -f pipeline_make_sf_crime_06.py" ]; then python -u pipeline_make_sf_crime_06.py;
            else echo "POI adƒ±mƒ± bulunamadƒ±"; exit 2; fi
          fi
          [ -f "${CRIME_DATA_DIR}/sf_crime_06.csv" ] && { echo "---- sf_crime_06.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_06.csv" || true; }
      
      - name: FR 06) POI ‚Üí fr_crime_06.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          CRIME_DATA_DIR:  ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if   [ -f "update_poi.fr.py" ]; then PY="update_poi.fr.py";
          elif [ -f "update_poi_fr.py" ]; then PY="update_poi_fr.py";
          elif [ -f "scripts/update_poi.fr.py" ]; then PY="scripts/update_poi.fr.py";
          elif [ -f "scripts/update_poi_fr.py" ]; then PY="scripts/update_poi_fr.py";
          elif [ -f "update_poi.py" ]; then PY="update_poi.py";
          elif [ -f "scripts/pipeline_make_sf_crime_06.py" ]; then PY="scripts/pipeline_make_sf_crime_06.py";
          else echo "‚Ü™Ô∏è FR POI scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_06.csv" || { echo "‚ùå fr_crime_06.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_06.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_06.csv" || true
      
      # =========================
      # 08) Police/Gov ‚Ä¢ SF & FR (head 5)
      # =========================
      - name: 08) Polis & Devlet binalarƒ± ‚Üí sf_crime_07.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -e
          if [ "${PIPELINE_VARIANT}" = "fr" ]; then
            if   [ -f "update_police_gov.fr.py" ]; then python -u update_police_gov.fr.py;
            elif [ -f "update_police_gov_fr.py" ]; then python -u update_police_gov_fr.py;
            elif [ -f "update_police_gov.py" ];    then python -u update_police_gov.py;
            elif [ -f "scripts/enrich_police_gov_06_to_07.py" ]; then python -u scripts/enrich_police_gov_06_to_07.py;
            else echo "Polis/Gov adƒ±mƒ± bulunamadƒ±"; exit 2; fi
          else
            if [ -f "update_police_gov.py" ]; then python -u update_police_gov.py;
            elif [ -f "scripts/enrich_police_gov_06_to_07.py" ]; then python -u scripts/enrich_police_gov_06_to_07.py;
            else echo "Polis/Gov adƒ±mƒ± bulunamadƒ±"; exit 2; fi
          fi
          [ -f "${CRIME_DATA_DIR}/sf_crime_07.csv" ] && { echo "---- sf_crime_07.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/sf_crime_07.csv" || true; }
      
      - name: FR 07) Polis & Devlet ‚Üí fr_crime_07.csv
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          CRIME_DATA_DIR:  ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if   [ -f "update_police_gov.fr.py" ]; then PY="update_police_gov.fr.py";
          elif [ -f "update_police_gov_fr.py" ]; then PY="update_police_gov_fr.py";
          elif [ -f "scripts/enrich_police_gov_06_to_07.fr.py" ]; then PY="scripts/enrich_police_gov_06_to_07.fr.py";
          elif [ -f "scripts/enrich_police_gov_06_to_07_fr.py" ]; then PY="scripts/enrich_police_gov_06_to_07_fr.py";
          elif [ -f "update_police_gov.py" ]; then PY="update_police_gov.py";
          elif [ -f "scripts/enrich_police_gov_06_to_07.py" ]; then PY="scripts/enrich_police_gov_06_to_07.py";
          else echo "‚Ü™Ô∏è FR police/gov scripti yok, adƒ±m atlandƒ±."; exit 0; fi
          python -u "$PY"
          test -f "${CRIME_DATA_DIR}/fr_crime_07.csv" || { echo "‚ùå fr_crime_07.csv √ºretilmedi"; exit 2; }
          echo "---- fr_crime_07.csv (head) ----"; head -n 5 "${CRIME_DATA_DIR}/fr_crime_07.csv" || true
      
      # =========================
      # 09) Weather ‚Ä¢ FR ar≈üiv (merge YOK) | SF: yok
      # =========================
      - name: FR 08) (Opsiyonel) Weather ar≈üivini √ºret, MERGE YAPMA
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PIPELINE_VARIANT == 'fr' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          if [ -f "update_weather.py" ]; then
            python -u update_weather.py
          elif [ -f "scripts/update_weather.py" ]; then
            python -u scripts/update_weather.py
          else
            echo "‚Ü™Ô∏è Weather script yok, atlandƒ±."
          fi
          if [ -f "sf_weather_5years.csv" ]; then
            mkdir -p "${CRIME_DATA_DIR}"
            cp -f sf_weather_5years.csv "${CRIME_DATA_DIR}/sf_weather_5years.csv"
            echo "sf_weather_5years.csv ‚Äî ilk 5 satƒ±r:"; head -n 5 "${CRIME_DATA_DIR}/sf_weather_5years.csv" || true
          fi
      
      # =========================
      # 10) Neighbors ‚Ä¢ SF(07‚Üí08) & FR(08‚Üí09)
      # =========================
      - name: 10) SF kom≈üuluk ‚Üí sf_crime_08.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          SRC="${CRIME_DATA_DIR}/sf_crime_07.csv"
          DST="${CRIME_DATA_DIR}/sf_crime_08.csv"
          test -f "$SRC" || { echo "‚ùå Girdi eksik: $SRC"; exit 2; }
          echo "‚ñ∂Ô∏é SF kom≈üuluk zenginle≈ütirme: $SRC ‚Üí $DST"
          if [ -f "scripts/make_neighbors.py" ]; then
            python -u scripts/make_neighbors.py --in "$SRC" --out "$DST" || python -u scripts/make_neighbors.py
          elif [ -f "make_neigbors.py" ]; then
            python -u make_neigbors.py --in "$SRC" --out "$DST" || python -u make_neigbors.py
          else
            echo "‚ùå scripts/make_neighbors.py bulunamadƒ±"; exit 2
          fi
          test -f "$DST" || { echo "‚ùå Beklenen √ßƒ±ktƒ± yok: $DST"; exit 2; }
          echo "---- sf_crime_08.csv (head) ----"; head -n 5 "$DST" || true
      
      - name: 10.1) FR kom≈üuluk ‚Üí fr_crime_09.csv
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          SRC="${CRIME_DATA_DIR}/fr_crime_08.csv"
          [ -f "$SRC" ] || SRC="${CRIME_DATA_DIR}/fr_crime_07.csv"
          DST="${CRIME_DATA_DIR}/fr_crime_09.csv"
          if [ -f "$SRC" ]; then
            echo "‚ñ∂Ô∏é FR kom≈üuluk zenginle≈ütirme: $SRC ‚Üí $DST"
            if [ -f "scripts/make_neighbors_fr.py" ]; then
              python -u scripts/make_neighbors_fr.py --in "$SRC" --out "$DST" || python -u scripts/make_neighbors_fr.py
            elif [ -f "make_neigbors_fr.py" ]; then
              python -u make_neigbors_fr.py --in "$SRC" --out "$DST" || python -u make_neigbors_fr.py
            else
              echo "‚ùå scripts/make_neighbors_fr.py bulunamadƒ±"; exit 2
            fi
            test -f "$DST" || { echo "‚ùå Beklenen √ßƒ±ktƒ± yok: $DST"; exit 2; }
            echo "---- fr_crime_09.csv (head) ----"; head -n 5 "$DST" || true
          else
            echo "‚Ü™Ô∏è FR girdi yok (fr_crime_07/08). Adƒ±m atlandƒ±."
          fi
      
      # =========================
      # 11) Feature Analysis (EDA) ‚Ä¢ SF sonra FR
      # =========================
      - name: 11) SF Feature Analysis (EDA only)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -euo pipefail
          SF_IN="${CRIME_DATA_DIR}/sf_crime_08.csv"
          OUTDIR="outputs_feature_analysis/sf_08"
          if [ -f "${SF_IN}" ]; then
            echo "‚ñ∂Ô∏é SF EDA: ${SF_IN} ‚Üí ${OUTDIR}"
            python -u unified_feature_analysis.py --csv "${SF_IN}" --outdir "${OUTDIR}"
            echo "‚úÖ SF EDA tamamlandƒ±."
            echo "---- sf_crime_08.csv (head) ----"; head -n 5 "${SF_IN}" || true
          else
            echo "‚Ü™Ô∏è ${SF_IN} bulunamadƒ±, SF EDA atlandƒ±."
          fi
      
      - name: 11.1) FR Feature Analysis (EDA only)
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        run: |
          set -euo pipefail
          FR_IN="${CRIME_DATA_DIR}/fr_crime_09.csv"
          OUTDIR="outputs_feature_analysis/fr_09"
          if [ -f "${FR_IN}" ]; then
            echo "‚ñ∂Ô∏é FR EDA: ${FR_IN} ‚Üí ${OUTDIR}"
            python -u unified_feature_analysis.py --csv "${FR_IN}" --outdir "${OUTDIR}"
            echo "‚úÖ FR EDA tamamlandƒ±."
            echo "---- fr_crime_09.csv (head) ----"; head -n 5 "${FR_IN}" || true
          else
            echo "‚Ü™Ô∏è ${FR_IN} bulunamadƒ±, FR EDA atlandƒ±."
          fi
      
      # =========================
      # 12) QC & Preview ‚Ä¢ SF(08) + FR(09)
      # =========================
      - name: "12) Kalite kontrol + hƒ±zlƒ± √∂nizleme"
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          SF="${CRIME_DATA_DIR}/sf_crime_08.csv"
          if [ -f "$SF" ]; then
            echo "‚úÖ SF Var: $SF  | boyut=$(stat -c%s "$SF" 2>/dev/null || stat -f%z "$SF") byte"
            echo "---- sf_crime_08.csv (head 5) ----"; head -n 5 "$SF" || true
          else
            echo "‚ÑπÔ∏è SF Yok: $SF"
          fi
          FR="${CRIME_DATA_DIR}/fr_crime_09.csv"
          if [ -f "$FR" ]; then
            echo "‚úÖ FR Var: $FR  | boyut=$(stat -c%s "$FR" 2>/dev/null || stat -f%z "$FR") byte"
            echo "---- fr_crime_09.csv (head 5) ----"; head -n 5 "$FR" || true
          else
            echo "‚ÑπÔ∏è FR Yok: $FR"
          fi
      
      # =========================
      # 13) Package ‚Ä¢ Build paquet (zip) + preview
      # =========================
      - name: 13) Package ‚Ä¢ Build paquet (zip) + preview
        if: ${{ steps.gate.outputs.proceed == 'true' }}
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          PKG_DIR="_pkg"; mkdir -p "$PKG_DIR"
          bytes() { stat -c%s "$1" 2>/dev/null || stat -f%z "$1" 2>/dev/null || echo "?"; }
          add_file() {
            local SRC="$1"; local DSTDIR="$2"
            if [ -f "$SRC" ]; then
              cp -f "$SRC" "$DSTDIR/"
              local SIZE; SIZE=$(bytes "$SRC")
              echo "‚úÖ Eklendi: $SRC  | boyut=${SIZE} byte"
              echo "---- $(basename "$SRC") (head 5) ----"; head -n 5 "$SRC" || true
            else
              echo "‚ÑπÔ∏è Dosya yok, atlandƒ±: $SRC"
            fi
          }
          echo "‚ñ∂Ô∏é Paketleme ba≈ülƒ±yor‚Ä¶"
          add_file "${CRIME_DATA_DIR}/sf_crime.csv"            "$PKG_DIR"
          add_file "${CRIME_DATA_DIR}/sf_crime_08.csv"         "$PKG_DIR"
          add_file "${CRIME_DATA_DIR}/fr_crime_09.csv"         "$PKG_DIR"
          add_file "${CRIME_DATA_DIR}/fr_crime_08.csv"         "$PKG_DIR"
          add_file "${CRIME_DATA_DIR}/sf_weather_5years.csv"   "$PKG_DIR"
          cp -f ${CRIME_DATA_DIR}/sf_crime_L*.csv "$PKG_DIR/" 2>/dev/null || true
          if ls ${CRIME_DATA_DIR}/sf_crime_L*.csv >/dev/null 2>&1; then
            echo "‚úÖ Eklendi: sf_crime_L*.csv seti"
            for f in ${CRIME_DATA_DIR}/sf_crime_L*.csv; do [ -f "$f" ] && { echo "---- $(basename "$f") (head 5) ----"; head -n 5 "$f" || true; }; done
          fi
          if [ -d "outputs_feature_analysis/fr_09" ]; then
            mkdir -p "$PKG_DIR/fr_eda"; cp -rf outputs_feature_analysis/fr_09/* "$PKG_DIR/fr_eda/" || true
            echo "‚úÖ Eklendi: outputs_feature_analysis/fr_09 ‚Üí _pkg/fr_eda/"
          fi
          echo "----- Paket i√ßeriƒüi (liste) -----"; ls -lah "$PKG_DIR" || true; [ -d "$PKG_DIR/fr_eda" ] && { echo "----- fr_eda/ -----"; ls -lah "$PKG_DIR/fr_eda" || true; }
          ZIP_NAME="paquet_run_${GITHUB_RUN_NUMBER}.zip"
          (cd "$PKG_DIR" && zip -r "../${ZIP_NAME}" . >/dev/null || true)
          echo "üéÅ ZIP olu≈üturuldu: ${ZIP_NAME}"
      
      # =========================
      # 14) Persist ‚Äî artifact / commit / release
      # =========================
      - name: 14a) Upload artifacts (paquet + EDA + CSVs)
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PERSIST_MODE == 'artifact' }}
        uses: actions/upload-artifact@v4
        with:
          name: sf-crime-pipeline-output
          if-no-files-found: warn
          path: |
            paquet_run_${{ github.run_number }}.zip
            ${{ env.CRIME_DATA_DIR }}/sf_crime.csv
            ${{ env.CRIME_DATA_DIR }}/sf_crime_08.csv
            ${{ env.CRIME_DATA_DIR }}/fr_crime_09.csv
            ${{ env.CRIME_DATA_DIR }}/fr_crime_08.csv
            ${{ env.CRIME_DATA_DIR }}/sf_weather_5years.csv
            ${{ env.CRIME_DATA_DIR }}/sf_crime_L*.csv
            outputs_feature_analysis/fr_09/**
            outputs_feature_analysis/sf_08/**
      
      - name: 14b) Commit outputs to repo
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PERSIST_MODE == 'commit' }}
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A \
            outputs_feature_analysis/fr_09 \
            outputs_feature_analysis/sf_08 \
            "${CRIME_DATA_DIR}/fr_crime_09.csv" \
            "${CRIME_DATA_DIR}/sf_crime.csv" \
            "${CRIME_DATA_DIR}/sf_crime_08.csv" \
            "${CRIME_DATA_DIR}/fr_crime_08.csv" \
            "${CRIME_DATA_DIR}/sf_weather_5years.csv" \
            ${CRIME_DATA_DIR}/sf_crime_L*.csv 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Pipeline outputs (EDA + key CSVs) [run $GITHUB_RUN_NUMBER]"
            git push
          fi
      
      - name: 14c) Release FR/SF outputs (zip dahil)
        if: ${{ steps.gate.outputs.proceed == 'true' && env.PERSIST_MODE == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          tag_name: pipeline-${{ github.run_number }}
          name: "Pipeline Outputs #${{ github.run_number }}"
          files: |
            paquet_run_${{ github.run_number }}.zip
            outputs_feature_analysis/fr_09/**/*
            outputs_feature_analysis/sf_08/**/*
            ${{ env.CRIME_DATA_DIR }}/fr_crime_09.csv
            ${{ env.CRIME_DATA_DIR }}/fr_crime_08.csv
            ${{ env.CRIME_DATA_DIR }}/sf_crime.csv
            ${{ env.CRIME_DATA_DIR }}/sf_crime_08.csv
            ${{ env.CRIME_DATA_DIR }}/sf_crime_L*.csv
            ${{ env.CRIME_DATA_DIR }}/sf_weather_5years.csv

