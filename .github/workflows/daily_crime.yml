name: Daily FR Grid/Events Enrichment

on:
  workflow_dispatch:
  schedule:
    - cron: "30 04 * * *"   # 07:30 Europe/Istanbul

permissions:
  contents: read
  actions: read

concurrency:
  group: fr-daily-grid-events-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Europe/Istanbul
  CRIME_DATA_DIR: crime_prediction_data
  # Girdi/Ã‡Ä±ktÄ± dosyalarÄ± (aynÄ± isimle yerinde gÃ¼ncellenir)
  FR_GRID_DAILY_IN:  fr_crime_grid_daily.csv
  FR_GRID_DAILY_OUT: fr_crime_grid_daily.csv
  FR_EVENTS_DAILY_IN:  fr_crime_events_daily.csv
  FR_EVENTS_DAILY_OUT: fr_crime_events_daily.csv
  # KomÅŸuluk dosyasÄ± (repo kÃ¶kÃ¼ veya data altÄ±nda olabilir)
  NEIGH_FILE: neighbors.csv

jobs:
  enrich-fr-daily:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install pandas numpy scikit-learn pyproj shapely geopandas fiona rtree

      - name: Show working tree
        run: |
          echo "ðŸ“‚ CWD: $PWD"
          ls -lah
          echo "ðŸ“‚ Data dir:"
          ls -lah "${CRIME_DATA_DIR}" || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (0) Daily + Y_label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (0) Build FR daily (GRID & EVENTS) + Y_label
        env:
          CRIME_DATA_DIR:        ${{ env.CRIME_DATA_DIR }}
          FR_EVENTS_PATH:        ${{ env.CRIME_DATA_DIR }}/fr_crime.csv
          FR_OUT_EVENTS:         ${{ env.CRIME_DATA_DIR }}/fr_crime_events_daily.csv
          FR_OUT_GRID:           ${{ env.CRIME_DATA_DIR }}/fr_crime_grid_daily.csv
          FR_MIN_YEARS:          "5"     # en az 5 yÄ±l pencere
          FR_DATE_COL:           "incident_datetime"
          FR_GEOID_COL:          "GEOID"
          FR_ID_COL:             "id"
        run: |
          set -e
          python -u update_crime_fr_daily.py
          echo "---- GRID head ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_grid_daily.csv" || true
          echo "---- EVENTS head ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_events_daily.csv" || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 911 â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (1) 911 â†’ enrich GRID & EVENTS
        env:
          FR_911_PATH: "${{ env.CRIME_DATA_DIR }}/sf_911_last_5_year.csv"
          FR_911_DATE_COL: "incident_datetime"
          FR_911_GEOID_COL: "GEOID"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u enrich_with_911.py

      - name: Preview after 911
        run: |
          echo "---- GRID (head) ----"
          head -n 5 "${CRIME_DATA_DIR}/${FR_GRID_DAILY_OUT}" || true
          echo "---- EVENTS (head) ----"
          head -n 5 "${CRIME_DATA_DIR}/${FR_EVENTS_DAILY_OUT}" || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 311 â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (2) 311 â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
          # EÄŸer direkt gÃ¼nlÃ¼k 311 dosyan var ise belirt (opsiyonel):
          FR_311_DAILY_IN: ""
          # Yoksa toplu dosyadan gÃ¼nlÃ¼k Ã¼retilecek:
          AGG_311_NAME: "sf_311_last_5_years.csv"
        run: |
          set -e
          python -u enrich_with_311_daily.py

      - name: Preview after 311
        run: |
          echo "---- GRID cols ----"
          python - <<'PY'
import pandas as pd, os
p=os.path.join(os.getenv("CRIME_DATA_DIR"),os.getenv("FR_GRID_DAILY_OUT"))
df=pd.read_csv(p, nrows=0); print(list(df.columns))
PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUS â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (3) Bus stops â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          BUS_CANON_RAW: "sf_bus_stops_with_geoid.csv"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u update_bus_fr_daily.py

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TRAIN â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (4) Train stops â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          TRAIN_STOPS_NAME: "sf_train_stops_with_geoid.csv"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u update_train_fr_daily.py

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ POI â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (5) POI â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          # POI kaynaklarÄ± (en az biri mevcut olmalÄ±)
          POI_GEOJSON_1: "${{ env.CRIME_DATA_DIR }}/sf_pois.geojson"
          POI_GEOJSON_2: "sf_pois.geojson"
          POI_CLEAN_CSV: "${{ env.CRIME_DATA_DIR }}/sf_pois_cleaned_with_geoid.csv"
          BLOCK_GEOJSON: "${{ env.CRIME_DATA_DIR }}/sf_census_blocks_with_population.geojson"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u update_poi_fr_daily.py

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ POLICE & GOV â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (6) Police & Government â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          POLICE_FILE: "sf_police_stations.csv"
          GOV_FILE: "sf_government_buildings.csv"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u update_police_gov_daily.py

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WEATHER â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (7) Weather (date-merge) â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          WEATHER_FILE: "sf_weather_5years.csv"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u update_weather_fr_daily.py

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NEIGHBORS â†’ GRID/EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: (8) Neighbor windows (1/3/7d, shift(1)) â†’ enrich GRID & EVENTS
        env:
          CRIME_DATA_DIR: "${{ env.CRIME_DATA_DIR }}"
          NEIGH_FILE: "${{ env.NEIGH_FILE }}"
          FR_GRID_DAILY_IN:  "${{ env.FR_GRID_DAILY_IN }}"
          FR_GRID_DAILY_OUT: "${{ env.FR_GRID_DAILY_OUT }}"
          FR_EVENTS_DAILY_IN:  "${{ env.FR_EVENTS_DAILY_IN }}"
          FR_EVENTS_DAILY_OUT: "${{ env.FR_EVENTS_DAILY_OUT }}"
        run: |
          set -e
          python -u enrich_with_neighbors_daily.py

      - name: Final previews
        run: |
          echo "==== GRID (top 3 rows) ===="
          head -n 3 "${CRIME_DATA_DIR}/${FR_GRID_DAILY_OUT}" || true
          echo "==== EVENTS (top 3 rows) ===="
          head -n 3 "${CRIME_DATA_DIR}/${FR_EVENTS_DAILY_OUT}" || true
          echo "==== GRID column list ===="
          python - <<'PY'
import pandas as pd, os
p=os.path.join(os.getenv("CRIME_DATA_DIR"),os.getenv("FR_GRID_DAILY_OUT"))
df=pd.read_csv(p, nrows=0); print("\n".join(df.columns))
PY

      - name: Upload artifacts (GRID & EVENTS)
        uses: actions/upload-artifact@v4
        with:
          name: fr-daily-grid-events
          path: |
            ${{ env.CRIME_DATA_DIR }}/${{ env.FR_GRID_DAILY_OUT }}
            ${{ env.CRIME_DATA_DIR }}/${{ env.FR_EVENTS_DAILY_OUT }}
          if-no-files-found: warn
