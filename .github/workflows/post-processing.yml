name: Post Processing (FR)

on:
  workflow_run:
    workflows: ["Full SF Crime Pipeline"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  actions: read

concurrency:
  group: post-processing-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run_fr:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      CRIME_DATA_DIR: crime_prediction_data
      WX_LOCATION: "paris"
      WX_UNIT: "metric"
      GEOID_LEN: "11"

      ARTIFACT_ZIP: artifact/sf-crime-pipeline-output.zip
      ARTIFACT_DIR: artifact
      FR_OUTPUT_DIR: ${{ github.workspace }}/crime_prediction_data
      FALLBACK_DIRS: ${{ github.workspace }}/crime_prediction_data,${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure data dir (FR)
        run: mkdir -p "${CRIME_DATA_DIR}"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps (quick)
        run: |
          python -m pip install -U pip wheel setuptools
          [ -f requirements.txt ] && pip install -r requirements.txt || true

      - name: Install parquet engine
        run: |
          python -m pip install -U pyarrow pandas

      - name: Download upstream artifact (triggering run)
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: sf-crime-pipeline-output
          path: artifact

      - name: Unzip artifact if present (optional)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${{ env.ARTIFACT_ZIP }}" ]; then
            command -v unzip >/dev/null 2>&1 || { sudo apt-get update -y >/dev/null && sudo apt-get install -y unzip >/dev/null; }
            unzip -o "${{ env.ARTIFACT_ZIP }}" -d "${{ env.ARTIFACT_DIR }}"
          else
            echo "No artifact ZIP file found (this is fine)."
          fi

      # --- FR 00..09: Mevcut √ºretim adƒ±mlarƒ±n (fr_crime_09'a kadar) ---
      - name: FR 00) Base grid / event label merge
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_crime_fr.py
          head -n 5 "${CRIME_DATA_DIR}/sf_crime_grid_full_labeled.csv" || true

      - name: FR 01) 911
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_911_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_01.csv" || true

      - name: FR 02) 311
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_311_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_02.csv" || true

      - name: FR 03) Population
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_population_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_03.csv" || true

      - name: FR 04) Bus
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_bus_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_04.csv" || true

      - name: FR 05) Train
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_train_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_05.csv" || true

      - name: FR 06) POI
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_poi_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_06.csv" || true

      - name: FR 07) Police & Gov
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_police_gov_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_07.csv" || true

      - name: FR 08) Weather
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail
          python -u update_weather_fr.py || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_08.csv" || true

      - name: FR 09) Neighbors
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
        run: |
          set -euo pipefail
          if [ -f scripts/make_neighbors_fr.py ]; then
            PY=scripts/make_neighbors_fr.py
          elif [ -f make_neighbors_fr.py ]; then
            PY=make_neighbors_fr.py
          else
            echo "‚ö†Ô∏è make_neighbors_fr.py bulunamadƒ±, adƒ±m atlanƒ±yor."
            exit 0
          fi
          test -f "${CRIME_DATA_DIR}/fr_crime_08.csv" || echo "‚ö†Ô∏è fr_crime_08.csv yok (devam edilebilir)."
          python -u "$PY" || true
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_09.csv" || true

      - name: FR 11) Risk exports (hourly/daily/patrol + top-3)
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        shell: bash
        run: |
          set -euo pipefail

          echo "üîé Proba/DF adaylarƒ±nƒ± arƒ±yorum‚Ä¶"
          # DF adaylarƒ± (√∂ncelik fr_crime_09)
          DF_CANDS=(
            "${CRIME_DATA_DIR}/fr_crime_09.csv"
            "${CRIME_DATA_DIR}/fr_crime_08.csv"
            "${CRIME_DATA_DIR}/fr_crime.csv"
          )
          # Proba adaylarƒ± (CSV tek kolon ya da .npy)
          PROBA_CANDS=(
            "${CRIME_DATA_DIR}/y_pred_proba.csv"
            "${CRIME_DATA_DIR}/proba.csv"
            "${CRIME_DATA_DIR}/y_pred_proba.npy"
            "${CRIME_DATA_DIR}/proba.npy"
          )

          pick_first() {
            for p in "$@"; do
              if [ -f "$p" ]; then echo "$p"; return 0; fi
            done
            return 1
          }

          DF_PATH="$(pick_first "${DF_CANDS[@]}" || true)"
          PROBA_PATH="$(pick_first "${PROBA_CANDS[@]}" || true)"

          if [ -z "${DF_PATH:-}" ] || [ -z "${PROBA_PATH:-}" ]; then
            echo "‚ö†Ô∏è DF veya proba bulunamadƒ±. Risk export adƒ±mƒ± atlanƒ±yor."
            echo "    DF: ${DF_PATH:-yok}, PROBA: ${PROBA_PATH:-yok}"
            exit 0
          fi

          echo "‚úÖ DF: ${DF_PATH}"
          echo "‚úÖ PROBA: ${PROBA_PATH}"

          # Script konumu (repo k√∂k√º veya scripts/)
          if [ -f risk_exports_fr.py ]; then
            PY=risk_exports_fr.py
          elif [ -f scripts/risk_exports_fr.py ]; then
            PY=scripts/risk_exports_fr.py
          else
            echo "‚ùå risk_exports_fr.py bulunamadƒ±."
            exit 1
          fi

          python -u "$PY" --df "${DF_PATH}" --proba "${PROBA_PATH}" --threshold 0.5 --out-prefix ""
          # G√ºvenlik: Top-3 tabloyu 365 g√ºn penceresiyle de √ºretmeyi dene
          python -u "$PY" --df "${DF_PATH}" --proba "${PROBA_PATH}" --threshold 0.5 --out-prefix "" --top3-window-days 365 || true

          ls -l "${CRIME_DATA_DIR}" | sed -n '1,200p'

      - name: FR 12) Build 2 ZIPs with EXACT files (no fr_crime_10)
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, sys, zipfile
          from pathlib import Path
          import pandas as pd

          base = Path(os.environ.get("CRIME_DATA_DIR","crime_prediction_data")).resolve()
          extra = Path(os.environ.get("ARTIFACT_DIR","artifact")).resolve()
          base.mkdir(parents=True, exist_ok=True)
          extra.mkdir(parents=True, exist_ok=True)

          # Paketlere girmesi istenenler
          WANT_CSV = [
            "fr_crime_09.csv",
            "risk_hourly.csv",
            "risk_daily.csv",
            "patrol_recs.csv",
            "risk_types_top3.csv",
            "metrics_stacking_ohe.csv",
          ]
          WANT_PQ  = [
            "fr_crime_09.parquet",
            "risk_hourly.parquet",
            "risk_daily.parquet",
            "patrol_recs.parquet",
            "metrics_stacking_ohe.parquet",
          ]

          def find_one(name: str):
            # √ñnce CRIME_DATA_DIR, sonra artifact dizini
            cands = list(base.rglob(name)) + list(extra.rglob(name))
            return cands[0] if cands else None

          # CSV‚ÜîParquet d√∂n√º≈üt√ºrme yardƒ±mcƒ±larƒ±
          def ensure_parquet(csv_path: Path) -> Path|None:
            try:
              df = pd.read_csv(csv_path, low_memory=False)
              pq = csv_path.with_suffix(".parquet")
              df.to_parquet(pq, index=False)
              print(f"[MAKE] {pq.name} from {csv_path.name}")
              return pq
            except Exception as e:
              print(f"[WARN] {csv_path.name} ‚Üí parquet √ºretilemedi: {e}", file=sys.stderr)
              return None

          def ensure_csv(pq_path: Path) -> Path|None:
            try:
              df = pd.read_parquet(pq_path)
              csv = pq_path.with_suffix(".csv")
              df.to_csv(csv, index=False)
              print(f"[MAKE] {csv.name} from {pq_path.name}")
              return csv
            except Exception as e:
              print(f"[WARN] {pq_path.name} ‚Üí csv √ºretilemedi: {e}", file=sys.stderr)
              return None

          # fr_crime_09 en az bir formatta garanti olsun
          csv_09 = find_one("fr_crime_09.csv")
          pq_09  = find_one("fr_crime_09.parquet")
          if csv_09 is None and pq_09 is None:
            print("‚ùå fr_crime_09.(csv|parquet) yok; √∂nceki adƒ±mlarƒ± kontrol edin.", file=sys.stderr)
            sys.exit(1)
          if pq_09 is None and csv_09 is not None:
            pq_09 = ensure_parquet(csv_09)
          if csv_09 is None and pq_09 is not None:
            csv_09 = ensure_csv(pq_09)

          sel_csv, sel_pq = [], []

          def add_if_exists(bucket, name):
            p = find_one(name)
            if p is not None and "fr_crime_10" not in p.name:
              bucket.append(p)

          for n in WANT_CSV: add_if_exists(sel_csv, n)
          for n in WANT_PQ:  add_if_exists(sel_pq,  n)

          # Minimum g√ºvence: fr_crime_09 her iki listede de bulunsun
          if not any(p.name == "fr_crime_09.csv" for p in sel_csv) and csv_09 is not None:
            sel_csv.append(csv_09)
          if not any(p.name == "fr_crime_09.parquet" for p in sel_pq) and pq_09 is not None:
            sel_pq.append(pq_09)

          # Eƒüer risk CSV var ama parquet yoksa d√∂n√º≈üt√ºr (ve tersi)
          def ensure_pair(csv_name, pq_name):
            csv_p = find_one(csv_name)
            pq_p  = find_one(pq_name)
            if csv_p is not None and pq_p is None:
              made = ensure_parquet(csv_p)
              if made is not None: sel_pq.append(made)
            if pq_p is not None and csv_p is None:
              made = ensure_csv(pq_p)
              if made is not None: sel_csv.append(made)

          ensure_pair("risk_hourly.csv",   "risk_hourly.parquet")
          ensure_pair("risk_daily.csv",    "risk_daily.parquet")
          ensure_pair("patrol_recs.csv",   "patrol_recs.parquet")
          ensure_pair("metrics_stacking_ohe.csv", "metrics_stacking_ohe.parquet")

          out_csv_zip = base / "fr_csv_outputs.zip"
          out_pq_zip  = base / "fr_parquet_outputs.zip"

          def arcname_for(p: Path) -> Path:
            try:
              pr = p.resolve()
              if str(pr).startswith(str(base.resolve())):
                return pr.relative_to(base)
              if str(pr).startswith(str(extra.resolve())):
                return Path("artifact") / pr.relative_to(extra)
            except Exception:
              pass
            return Path(p.name)

          # CSV ZIP
          with zipfile.ZipFile(out_csv_zip, "w", compression=zipfile.ZIP_DEFLATED) as z:
            for p in sel_csv:
              z.write(p, arcname=str(arcname_for(p)))
              print(f"+ CSV: {p.name}")
          print(f"‚úÖ CSV ZIP hazƒ±r: {out_csv_zip}")

          # PARQUET ZIP
          with zipfile.ZipFile(out_pq_zip, "w", compression=zipfile.ZIP_DEFLATED) as z:
            for p in sel_pq:
              z.write(p, arcname=str(arcname_for(p)))
              print(f"+ PQ: {p.name}")
          print(f"‚úÖ Parquet ZIP hazƒ±r: {out_pq_zip}")
          PY
          
      - name: Upload FR outputs (CSV ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: fr-crime-outputs-csv
          path: ${{ env.CRIME_DATA_DIR }}/fr_csv_outputs.zip
          if-no-files-found: error
          retention-days: 14
          overwrite: true     # ‚Üê EKLENDƒ∞

      - name: Upload FR outputs (Parquet ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: fr-crime-outputs-parquet
          path: ${{ env.CRIME_DATA_DIR }}/fr_parquet_outputs.zip
          if-no-files-found: error
          retention-days: 14
          overwrite: true     # ‚Üê EKLENDƒ∞

