name: Post Processing (FR)

on:
  workflow_run:
    workflows: ["Full SF Crime Pipeline"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  actions: read

jobs:
  run_fr:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      CRIME_DATA_DIR: crime_prediction_data
      WX_LOCATION: "paris"
      WX_UNIT: "metric"
      GEOID_LEN: "11"

      ARTIFACT_ZIP: artifact/sf-crime-pipeline-output.zip
      ARTIFACT_DIR: artifact
      FR_OUTPUT_DIR: ${{ github.workspace }}/crime_prediction_data
      FALLBACK_DIRS: ${{ github.workspace }}/crime_prediction_data,${{ github.workspace }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure data dir (FR)
        run: mkdir -p "${CRIME_DATA_DIR}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install core deps (pip + project requirements if present)
        run: |
          set -e
          python -m pip install -U pip wheel setuptools
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # pyarrow/pandas FR 10'dan √∂nce kurulmalƒ±
      - name: Install parquet engine
        run: |
          set -e
          python -m pip install -U pyarrow pandas

      - name: Install OS tools (zip/unzip/find)
        run: |
          set -e
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y unzip zip >/dev/null

      - name: Download upstream artifact (triggering run)
        uses: dawidd6/action-download-artifact@v6
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: sf-crime-pipeline-output
          path: artifact

      - name: Unzip artifact if present (optional)
        run: |
          set -e
          if [ -f "${{ env.ARTIFACT_ZIP }}" ]; then
            unzip -o "${{ env.ARTIFACT_ZIP }}" -d "${{ env.ARTIFACT_DIR }}"
          else
            echo "No artifact ZIP file found (this is fine)."
          fi
          echo "---- artifact dir tree ----"
          (cd "${{ env.ARTIFACT_DIR }}" && /usr/bin/find . -maxdepth 3 -type f -printf "%p\t%k KB\n" || true)

      - name: FR 00) Base grid / event label merge
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_crime_fr.py
          echo "---- head(sf_crime_grid_full_labeled.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/sf_crime_grid_full_labeled.csv" || true

      - name: FR 01) 911
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_911_fr.py || true
          echo "---- head(fr_crime_01.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_01.csv" || true

      - name: FR 02) 311
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_311_fr.py || true
          echo "---- head(fr_crime_02.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_02.csv" || true

      - name: FR 03) Population
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_population_fr.py || true
          echo "---- head(fr_crime_03.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_03.csv" || true

      - name: FR 04) Bus
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_bus_fr.py || true
          echo "---- head(fr_crime_04.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_04.csv" || true

      - name: FR 05) Train
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_train_fr.py || true
          echo "---- head(fr_crime_05.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_05.csv" || true

      - name: FR 06) POI
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_poi_fr.py || true
          echo "---- head(fr_crime_06.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_06.csv" || true

      - name: FR 07) Police & Gov
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_police_gov_fr.py || true
          echo "---- head(fr_crime_07.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_07.csv" || true

      - name: FR 08) Weather
        env:
          ARTIFACT_ZIP: ${{ env.ARTIFACT_ZIP }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -e
          python -u update_weather_fr.py || true
          echo "---- head(fr_crime_08.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_08.csv" || true

      - name: FR 09) Neighbors
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
        run: |
          set -e
          if [ -f scripts/make_neighbors_fr.py ]; then
            PY=scripts/make_neighbors_fr.py
          elif [ -f make_neighbors_fr.py ]; then
            PY=make_neighbors_fr.py
          else
            echo "‚ö†Ô∏è make_neighbors_fr.py bulunamadƒ±, adƒ±m atlanƒ±yor."
            exit 0
          fi

          if [ ! -f "${CRIME_DATA_DIR}/fr_crime_08.csv" ]; then
            echo "‚ö†Ô∏è fr_crime_08.csv bulunamadƒ±, neighbors adƒ±mƒ± atlanƒ±yor."
            exit 0
          fi

          python -u "$PY" || true
          echo "---- head(fr_crime_09.csv) ----"
          head -n 5 "${CRIME_DATA_DIR}/fr_crime_09.csv" || true

      - name: FR 10) Build fr_crime_10.parquet (script)
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -e
          echo "PWD=$(pwd)"
          ls -lah
          echo "---- scripts/ ----"
          ls -lah scripts || true
          echo "---- data dir ----"
          ls -lah "${CRIME_DATA_DIR}" || true

          # script var mƒ±?
          test -f scripts/make_fr_crime_10.py || { echo "‚ùå scripts/make_fr_crime_10.py yok!"; exit 1; }

          # girdi var mƒ±?
          if [ ! -f "${CRIME_DATA_DIR}/fr_crime_09.parquet" ] && [ ! -f "${CRIME_DATA_DIR}/fr_crime_09.csv" ]; then
            echo "‚ùå fr_crime_09.(parquet|csv) bulunamadƒ±. FR 09 adƒ±mƒ±nƒ± doƒürulayƒ±n."
            exit 1
          fi

          python -u scripts/make_fr_crime_10.py
          echo "---- output ----"
          ls -lh "${CRIME_DATA_DIR}/fr_crime_10.parquet"

      - name: FR 11) Package minimal outputs (CSV & Parquet)
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
          ARTIFACT_DIR: ${{ env.ARTIFACT_DIR }}
          FR_OUTPUT_DIR: ${{ env.FR_OUTPUT_DIR }}
          FALLBACK_DIRS: ${{ env.FALLBACK_DIRS }}
        run: |
          set -euo pipefail

          echo "üîé Aranacak dosyalar:"
          PARQ_LIST=("fr_crime_09.parquet" "fr_crime_10.parquet" "metrics_base_ohe.parquet" "risk_hourly.parquet")
          CSV_LIST=("fr_crime_09.csv" "fr_crime_10.csv")

          # Arama dizinleri (√∂ncelik sƒ±rasƒ±)
          IFS=',' read -r -a EXTRA_DIRS <<< "${FALLBACK_DIRS}"
          SEARCH_DIRS=("${CRIME_DATA_DIR}" "${ARTIFACT_DIR}" "${ARTIFACT_DIR}/artifact" "${FR_OUTPUT_DIR}")
          if [ -n "${GITHUB_WORKSPACE:-}" ] && [ -d "${GITHUB_WORKSPACE}" ]; then
            SEARCH_DIRS+=("${GITHUB_WORKSPACE}")
          fi
          for d in "${EXTRA_DIRS[@]}"; do
            if [ -n "$d" ] && [ -d "$d" ]; then SEARCH_DIRS+=("$d"); fi
          done

          mkdir -p "${CRIME_DATA_DIR}/_pkg_parquet" "${CRIME_DATA_DIR}/_pkg_csv"

          find_and_copy() {
            local fname="$1"; shift
            local outdir="$1"; shift
            for dir in "${SEARCH_DIRS[@]}"; do
              if [ -f "${dir}/${fname}" ]; then
                echo "‚úÖ bulundu: ${dir}/${fname}"
                cp -f "${dir}/${fname}" "${outdir}/"
                return 0
              fi
              if [ -d "${dir}" ]; then
                hit="$(/usr/bin/find "${dir}" -type f -name "${fname}" -print -quit || true)"
                if [ -n "${hit}" ]; then
                  echo "‚úÖ bulundu (derin): ${hit}"
                  cp -f "${hit}" "${outdir}/"
                  return 0
                fi
              fi
            done
            echo "‚ö†Ô∏è bulunamadƒ±: ${fname}"
            return 1
          }

          echo "üì¶ Parquet dosyalarƒ± toplanƒ±yor..."
          PARQ_FOUND=0
          for f in "${PARQ_LIST[@]}"; do
            if find_and_copy "${f}" "${CRIME_DATA_DIR}/_pkg_parquet"; then PARQ_FOUND=1; fi
          done
          # En az bir dosya olsun diye bo≈ü ise README ekleyelim
          if [ "${PARQ_FOUND}" -eq 0 ]; then
            echo "No parquet outputs were found in this run." > "${CRIME_DATA_DIR}/_pkg_parquet/README.txt"
          fi

          echo "üóÇ CSV dosyalarƒ± toplanƒ±yor (varsa)..."
          CSV_FOUND=0
          for f in "${CSV_LIST[@]}"; do
            if find_and_copy "${f}" "${CRIME_DATA_DIR}/_pkg_csv"; then CSV_FOUND=1; fi
          done
          if [ "${CSV_FOUND}" -eq 0 ]; then
            echo "No CSV outputs were found in this run." > "${CRIME_DATA_DIR}/_pkg_csv/README.txt"
          fi

          echo "üß© Zip olu≈üturuluyor..."
          rm -f "${CRIME_DATA_DIR}/fr_parquet_outputs.zip" "${CRIME_DATA_DIR}/fr_csv_outputs.zip" || true
          (cd "${CRIME_DATA_DIR}/_pkg_parquet" && zip -r ../fr_parquet_outputs.zip . >/dev/null)
          (cd "${CRIME_DATA_DIR}/_pkg_csv"     && zip -r ../fr_csv_outputs.zip     . >/dev/null)

          echo "‚úÖ Paketler hazƒ±r:"
          ls -lh "${CRIME_DATA_DIR}/fr_parquet_outputs.zip" || true
          ls -lh "${CRIME_DATA_DIR}/fr_csv_outputs.zip" || true

          # (ƒ∞steƒüe baƒülƒ±) Zorunlu √º√ßl√º kontrol√º: eksikse job fail et
          mandatory=0
          for f in fr_crime_09.parquet metrics_base_ohe.parquet risk_hourly.parquet; do
            if [ ! -f "${CRIME_DATA_DIR}/_pkg_parquet/$f" ]; then
              echo "‚ùå Zorunlu parquet eksik: $f"
              mandatory=1
            fi
          done
          if [ $mandatory -eq 1 ]; then
            echo "‚ùå Zorunlu parquetlerden en az biri yok. Paket √ºretildi ancak eksik."
            # ƒ∞stersen exit 1 yaparak t√ºm job'u d√º≈ü√ºrebilirsin:
            # exit 1
          fi

      - name: Upload FR pipeline outputs (CSV ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: fr-crime-outputs-csv
          path: ${{ env.CRIME_DATA_DIR }}/fr_csv_outputs.zip
          if-no-files-found: error
          retention-days: 14

      - name: Upload FR pipeline outputs (Parquet ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: fr-crime-outputs-parquet
          path: ${{ env.CRIME_DATA_DIR }}/fr_parquet_outputs.zip
          if-no-files-found: error
          retention-days: 14
